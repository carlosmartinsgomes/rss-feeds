name: Generate RSS feeds (Node renderer + Python)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'   # opcional: roda a cada 30 minutos

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Playwright (Node) and deps
        working-directory: ${{ github.workspace }}/rss-feeds
        run: |
          npm install playwright --no-audit --no-fund
          # instala browsers necessários
          npx playwright install --with-deps

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r rss-feeds/requirements.txt

      - name: Render pages that need JS (Node)
        # Executa o script render_page.js para as páginas que precisam
        run: |
          mkdir -p rss-feeds/scripts/rendered

          echo "Rendering darkreading..."
          node rss-feeds/scripts/render_page.js https://www.darkreading.com/ rss-feeds/scripts/rendered/darkreading.html || echo "darkreading render failed"

          echo "Rendering iotworldtoday..."
          node rss-feeds/scripts/render_page.js https://www.iotworldtoday.com/ rss-feeds/scripts/rendered/iotworldtoday.html || echo "iotworldtoday render failed"

          echo "List rendered dir:"
          ls -la rss-feeds/scripts/rendered || true

      - name: Debug - show some files (opcional)
        run: |
          echo "sites.json:"
          sed -n '1,200p' rss-feeds/scripts/sites.json || true
          echo "rendered files sample head:"
          head -n 5 rss-feeds/scripts/rendered/darkreading.html || true
          head -n 5 rss-feeds/scripts/rendered/iotworldtoday.html || true

      - name: Run feed generator (Python)
        run: |
          python3 rss-feeds/scripts/generate_feeds.py

      - name: Commit feeds
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add rss-feeds/feeds/*.xml || true
          git commit -m "Update feeds" || echo "no changes to commit"
          git push origin HEAD:main || echo "push failed"
