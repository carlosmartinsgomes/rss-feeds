name: Playwright HAR scan (Docker)

on:
  workflow_dispatch:
    inputs:
      iteration_index:
        description: 'Iteration index (0..5)'
        required: true
        default: '0'
      geo:
        description: 'Optional geo code (e.g. US) or ALL'
        required: false
        default: 'ALL'
  # optional schedule: uncomment to run 6x/day automatically
  # schedule:
  #  - cron: '0 0 * * *'
  #  - cron: '0 4 * * *'
  #  - cron: '0 8 * * *'
  #  - cron: '0 12 * * *'
  #  - cron: '0 16 * * *'
  #  - cron: '0 20 * * *'

jobs:
  scan-in-docker:
    name: Run Playwright scan inside Docker (no host install required)
    runs-on: self-hosted   # or 'ubuntu-latest' if you prefer GitHub-hosted runners
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure output directory exists
        run: mkdir -p output

      - name: Run scan inside Playwright Docker image
        # This uses the official Playwright Python image which includes Python + Playwright + browsers
        # Note: requires the runner to have Docker installed and allow 'docker run'.
        env:
          ITERATION: ${{ github.event.inputs.iteration_index }}
          GEO: ${{ github.event.inputs.geo }}
        run: |
          echo "Running scan inside Docker container..."
          # pull image (choose tag you prefer; 'mcr.microsoft.com/playwright/python:latest' is typical)
          IMAGE="mcr.microsoft.com/playwright/python:latest"
          docker pull $IMAGE
          # run container, mount workspace and run script. This will run in container's python env.
          docker run --rm -v "${{ github.workspace }}":/work -w /work $IMAGE /bin/bash -lc "\
            pip install -r requirements.txt --no-warn-script-location || true && \
            python3 scan_page.py --targets targets.json --iteration ${ITERATION} --geo \"${GEO}\" --outdir output"
