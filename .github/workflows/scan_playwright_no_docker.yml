name: PubMatic Pipeline

on:
  schedule:
    - cron: "0 6 * * *"   # Slot 0  (06:00 UTC)
    - cron: "0 9 * * *"   # Slot 1  (09:00 UTC)
    - cron: "0 12 * * *"  # Slot 2  (12:00 UTC)
    - cron: "0 15 * * *"  # Slot 3  (15:00 UTC)
    - cron: "0 18 * * *"  # Slot 4  (18:00 UTC)
    - cron: "0 21 * * *"  # Slot 5  (21:00 UTC)

  workflow_dispatch:
    inputs:
      manual_slot:
        description: "Escolhe o slot (0–5) para correr manualmente"
        required: true
        default: "0"



jobs:
  run-slot:
    runs-on: [self-hosted, ip-172-31-78-172]

    steps:
      - name: Clean workspace
        working-directory: ${{ github.workspace }}
        run: |
          echo "Cleaning workspace..."
          git clean -fdx || true
          rm -rf ./* || true

      - name: Debug PWD
        run: |
          echo "PWD = $(pwd)"
          echo "Listing:"
          ls -lah

    
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # ---------------------------------------------------------
      # 1. Determinar slot base com base na hora UTC
      # ---------------------------------------------------------
      - name: Determine base slot
        id: slot_base
        run: |
          HOUR=$(date -u +"%H")
          if   [ "$HOUR" -ge 06 ] && [ "$HOUR" -lt 09 ]; then echo "slot=0"
          elif [ "$HOUR" -ge 09 ] && [ "$HOUR" -lt 12 ]; then echo "slot=1"
          elif [ "$HOUR" -ge 12 ] && [ "$HOUR" -lt 15 ]; then echo "slot=2"
          elif [ "$HOUR" -ge 15 ] && [ "$HOUR" -lt 18 ]; then echo "slot=3"
          elif [ "$HOUR" -ge 18 ] && [ "$HOUR" -lt 21 ]; then echo "slot=4"
          else echo "slot=5"
          fi


      # ---------------------------------------------------------
      # 1.b Slot final: usa manual_slot se for workflow_dispatch,
      # caso contrário usa o slot_base
      # ---------------------------------------------------------
      - name: Resolve final slot
        id: slot
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "slot=${{ github.event.inputs.manual_slot }}" >> $GITHUB_OUTPUT
          else
            echo "slot=${{ steps.slot_base.outputs.slot }}" >> $GITHUB_OUTPUT
          fi



      # ---------------------------------------------------------
      # 2. Correr scan_page.py em modo GLOBAL
      #    O scan_page.py decide automaticamente quais publishers
      #    pertencem ao slot, com base no weight_pct.
      # ---------------------------------------------------------
      - name: Run global slot scan
        if: ${{ steps.slot.outputs.slot != 'unknown' }}
        working-directory: ${{ github.workspace }}
        run: |
          SLOT=${{ steps.slot.outputs.slot }}
          echo "Running global scan for slot $SLOT"
          python scan_page.py --config targets.json --iteration "$SLOT" --verbose

      # ---------------------------------------------------------
      # 3. Calcular score diário apenas no slot 5
      # ---------------------------------------------------------
      - name: Compute daily score
        if: ${{ steps.slot.outputs.slot == '5' }}
        run: |
          echo "Computing daily score..."
          python compute_scores.py

      # ---------------------------------------------------------
      # 4. Agregar scores semanais/mensais apenas após score diário
      # ---------------------------------------------------------
      - name: Aggregate weekly/biweekly/monthly scores
        if: ${{ steps.slot.outputs.slot == '5' }}
        run: |
          echo "Aggregating scores..."
          python aggregate_scores.py
