name: PubMatic Pipeline

on:
  schedule:
    - cron: "0 6 * * *"   # Slot 0  (06:00 UTC)
    - cron: "0 9 * * *"   # Slot 1  (09:00 UTC)
    - cron: "0 12 * * *"  # Slot 2  (12:00 UTC)
    - cron: "0 15 * * *"  # Slot 3  (15:00 UTC)
    - cron: "0 18 * * *"  # Slot 4  (18:00 UTC)
    - cron: "0 21 * * *"  # Slot 5  (21:00 UTC)

  workflow_dispatch:

jobs:
  run-slot:
    runs-on: [self-hosted, ip-172-31-78-172]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Determine slot
        id: slot
        run: |
          HOUR=$(date -u +"%H")
          if   [ "$HOUR" = "06" ]; then echo "slot=0" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "09" ]; then echo "slot=1" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "12" ]; then echo "slot=2" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "15" ]; then echo "slot=3" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "18" ]; then echo "slot=4" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "21" ]; then echo "slot=5" >> $GITHUB_OUTPUT
          else echo "slot=unknown" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # 2. Escolher publishers por slot (slotting ideal)
      # ---------------------------------------------------------
      - name: Select publishers for this slot
        id: publishers
        run: |
          SLOT=${{ steps.slot.outputs.slot }}

          if [ "$SLOT" = "0" ]; then
            PUBS="X.com,FoxNews,IMDB,MLB"

          elif [ "$SLOT" = "1" ]; then
            PUBS="X.com,FoxNews,IMDB,Nextdoor"

          elif [ "$SLOT" = "2" ]; then
            PUBS="X.com,FoxNews,IMDB,NYPost"

          elif [ "$SLOT" = "3" ]; then
            PUBS="X.com,FoxNews,IMDB,Crunchyroll"

          elif [ "$SLOT" = "4" ]; then
            # Alternância para publishers pequenos
            if [ $(( $(date -u +%s) % 2 )) -eq 0 ]; then
              PUBS="Goodreads,Kayak"
            else
              PUBS="SoundCloud,FoxSports"
            fi

          elif [ "$SLOT" = "5" ]; then
            # Slot crítico → só publishers financeiros críticos
            PUBS="X.com,FoxNews,IMDB"

          else
            echo "Slot desconhecido — não correr scans."
            PUBS=""
          fi

          echo "pubs=$PUBS" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # 3. Correr scan_pages.py para cada publisher selecionado
      # ---------------------------------------------------------
      - name: Run scans
        if: ${{ steps.publishers.outputs.pubs != '' }}
        run: |
          IFS=',' read -ra PUBLIST <<< "${{ steps.publishers.outputs.pubs }}"
          for PUB in "${PUBLIST[@]}"; do
            echo "Running scan for $PUB"
            python scan_pages.py --config targets.json --publisher "$PUB"
          done

      - name: Compute daily score if needed
        run: |
          # If slot 5 ran → compute score
          if [ "${{ steps.slot.outputs.slot }}" = "5" ]; then
            python compute_scores.py
            exit 0
          fi

          # If slot 5 did NOT run today → fallback
          TODAY=$(date -u +"%Y-%m-%d")
          if [ ! -f "artifacts/$TODAY/score_done.flag" ]; then
            python compute_scores.py
          fi

      - name: Aggregate weekly/biweekly/monthly scores
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          if [ -f "artifacts/$TODAY/score_done.flag" ]; then
            python aggregate_scores.py
          else
            echo "Score diário ainda não calculado — não agrego."
          fi

